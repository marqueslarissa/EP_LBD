
TRIGGER

*Toda vez que um empregado é editado, uma copia dessa edição é salva através desta trigger na tabela
de histórico de empregados. 

CREATE OR REPLACE FUNCTION Save_history()
RETURNS trigger AS
$BODY$ BEGIN
INSERT INTO employee_history VALUES (100,current_timestamp,nrow.salary,nrow.level_knowledge,nrow.idt_employee);
RETURN NULL;
END; $BODY$
LANGUAGE 'plpgsql'


CREATE TRIGGER Save_history
AFTER UPDATE
ON employee_history
FOR EACH ROW
EXECUTE PROCEDURE Save_history();




/* Toda vez que um empregado é editado, uma copia dessa edição é salva através desta trigger na tabela
de histórico de empregados */

CREATE OR REPLACE FUNCTION processa_emp_history() RETURNS TRIGGER AS $processa_emp_history$  /* criação da função processa_emp_history  */
    BEGIN /*inico do bloco que vai verificar os comandos DML para atualização da tabela employee_history, selecionando os campos novos e inserindo na tabela*/
        IF (TG_OP = 'DELETE') THEN
            INSERT INTO employee_history(date_update, salary_update, level_knowledge_udpdate, idt_employee) SELECT now(),old.salary,old.idt_level_knowledge, OLD.idt_employee;
            RETURN OLD;
        ELSIF (TG_OP = 'UPDATE') THEN
            INSERT INTO employee_history(date_update, salary_update, level_knowledge_udpdate, idt_employee) SELECT now(),new.salary,new.idt_level_knowledge, OLD.idt_employee;
            RETURN NEW;
        ELSIF (TG_OP = 'INSERT') THEN
            INSERT INTO employee_history(date_update, salary_update, level_knowledge_udpdate, idt_employee) SELECT now(),new.salary,new.idt_level_knowledge, NEW.idt_employee;
            RETURN NEW;
        END IF;
        RETURN NULL; 
    END;
$processa_emp_history$ language plpgsql;


/* CRIAÇÃO DA TRIGGER - DEPOIS QUE QUALQUER COMANDO DML (INSERT, DELETE OU UPDATE) FOR EXECUTADO NA TABEA EMPLOYEE EXECUTE A FUNÇÃO processa_emp_history*/
CREATE TRIGGER emp_history
AFTER INSERT OR UPDATE OR DELETE ON employee
    FOR EACH ROW EXECUTE PROCEDURE processa_emp_history();



*Os times podem ter até 5 empregados em cada time, por isso essa trigger irá barrar caso haja a tentativa de inserção 
em um grupo com 5 ou mais empregados.
